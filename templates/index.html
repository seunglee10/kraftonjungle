<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>나홀로메모장 ver2.0</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
* {
    font-family: 'Stylish', sans-serif;
}

.wrap {
    width: 900px;
    margin: auto;
}

.post-box {
    background-color: #e9ecef;
    padding: 40px;
    border-radius: 5px;
    margin-bottom: 30px;
}

/* 신문식 레이아웃 */
#card-list {
    column-count: 3;
    column-gap: 0.75rem;
}

.card {
    break-inside: avoid;
    page-break-inside: avoid;
    height: 200px;
    margin-bottom: 1rem;
}

/* 카드 내부 grid */
.card-body {
    display: grid;
    grid-template-rows: 1fr auto;
    grid-template-areas:
        "main"
        "footer";
}

/* main 영역 */
.card-main {
    grid-area: main;
}

.card-title {
    white-space: normal;
    overflow-y: hidden;
    scrollbar-width: none;
    margin-bottom: 0.5rem;
}


.card-text {
    max-height: 55px;
    overflow-y: auto;
    scrollbar-width: none;
    font-size: 1.2rem;
}

.card-text:hover {
    scrollbar-width: thin;
}
.card-title,
.card-text,
.new-title,
.new-text {
    word-break: break-word;
    overflow-wrap: break-word;
}
/* 좋아요 수 (본문 하단) */
.card-likes {
    display: block;
    margin-top: 4px;
    font-size: 1.2rem; 
    color: #333;
}

/* footer 영역 */
.card-footer {
    grid-area: footer;
    display: flex;
    align-items: center;
    gap: 8px;

    background-color: #fff;
    border-top: none;
    padding-left: 0;
}
.card-footer button,
.card-footer .link-like,
.save-button {
    height: 32px;
    padding: 4px 12px;
    font-size: 14px;
}
/* 수정 모드 */
.new-title {
    white-space: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: none;
}

.new-text {
    max-height: 60px;
    overflow-y: auto;
    scrollbar-width: none;
}
.new-text:hover {
    scrollbar-width: thin;
}

/* 버튼 */
.link-like {
    cursor: pointer;
    color: #0d6efd;
}

.btn-edit {
    background-color: #17a2b8;
    color: white;
}
.btn-edit:hover {
    background-color: #138496;
    color: white;
}
</style>
</head>

<body>
<div class="wrap">

    <!-- 메모 작성 -->
    <div class="post-box">
        <h1 class="display-4">
            나홀로메모장
            <span class="badge bg-secondary">ver2.0</span>
        </h1>

        <form id="memo-form" class="mt-4">
            <div class="mb-3 col-md-8">
                <input
                    id="memo-title"
                    name="title"
                    type="text"
                    class="form-control"
                    maxlength="14"
                    placeholder="제목을 입력하세요"
                    required
                >
            </div>

            <div class="mb-3 col-md-8">
                <textarea
                    id="memo-content"
                    name="content"
                    class="form-control"
                    rows="3"
                    placeholder="내용을 입력하세요"
                    required
                ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">
                저장하기
            </button>
        </form>
    </div>

    <!-- 카드 목록 -->
    <div id="card-list">
        {% for memo in memos %}
        <div class="card" data-id="{{ memo._id }}" data-liked-at="0">
            <div class="card-body">

                <div class="card-main">
                    <h5 class="card-title">{{ memo.title }}</h5>
                    <p class="card-text">{{ memo.content }}</p>
                    <span class="card-likes">{{ memo.likes }}</span>
                </div>

                <div class="card-footer">
                    <button
                        class="edit-button btn btn-edit"
                        onclick="enterEditMode(this)">
                        수정
                    </button>

                    <button
                        class="delete-button btn btn-danger"
                        onclick="deleteMemo('{{ memo._id }}', this)">
                        삭제
                    </button>

                    <span
                        class="link-like btn btn-link text-decoration-none"
                        onclick="likeMemo('{{ memo._id }}')">
                        좋아요! <i class="bi bi-hand-thumbs-up"></i>
                    </span>
                </div>

            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
/* 메모 저장 */
document.getElementById("memo-form").addEventListener("submit", e => {
    e.preventDefault();
    fetch("/memo", {
        method: "POST",
        body: new FormData(e.target)
    }).then(() => location.reload());
});

/* 좋아요 */
function likeMemo(id) {
    const card = document.querySelector(`.card[data-id="${id}"]`);
    const likesEl = card.querySelector(".card-likes");

    likesEl.innerText = Number(likesEl.innerText) + 1;
    card.dataset.likedAt = Date.now();
    sortCards();

    fetch(`/like/${id}`, { method: "POST" })
        .catch(() => location.reload());
}

/* 좋아요 기준 정렬 */
function sortCards() {
    const list = document.getElementById("card-list");
    const cards = Array.from(list.children);

    cards.sort((a, b) => {
        const likesA = Number(a.querySelector(".card-likes").innerText);
        const likesB = Number(b.querySelector(".card-likes").innerText);

        // 1️⃣ 좋아요 수 우선
        if (likesA !== likesB) {
            return likesB - likesA;
        }

        // 2️⃣ 좋아요 수가 같으면 최근에 누른 카드 우선
        return Number(b.dataset.likedAt) - Number(a.dataset.likedAt);
    });

    cards.forEach(card => list.appendChild(card));
}

/* 삭제 */
function deleteMemo(id) {
    fetch(`/delete/${id}`, { method: "DELETE" })
        .then(() => location.reload());
}

/* 수정 */
function enterEditMode(btn) {
    const card = btn.closest(".card");

    const title = card.querySelector(".card-title").innerText;
    const content = card.querySelector(".card-text").innerText;

    const main = card.querySelector(".card-main");
    const footer = card.querySelector(".card-footer");

    main.innerHTML = `
        <input
            class="new-title form-control mb-2"
            maxlength="14"
            value="${title}">
        <textarea
            class="new-text form-control"
            rows="2">${content}</textarea>
    `;

    footer.innerHTML = `
        <button class="btn btn-success"
                onclick="saveEdit('${card.dataset.id}', this)">
            저장
        </button>
    `;
}

/* 수정 저장 */
function saveEdit(id, btn) {
    const card = btn.closest(".card");
    const title = card.querySelector(".new-title").value;
    const content = card.querySelector(".new-text").value;

    fetch(`/update/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ title, content })
    }).then(() => location.reload());
}
</script>
</body>
</html>
