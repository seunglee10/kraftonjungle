<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data:,">
    <title>나홀로메모장 ver2.0</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        * {
            font-family: 'Stylish', sans-serif;
        }

        .wrap {
            width: 900px;
            margin: auto;
        }

        .post-box {
            background-color: #e9ecef;
            padding: 40px;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        #card-list {
            column-count: 3;
            column-gap: 1rem;
        }

        .card {
            break-inside: avoid;
            min-height: 180px;
            margin-bottom: 10px;
        }

        .card-body {
            padding: 1rem;
        }

        .card-text {
            word-break: break-word;
            overflow-wrap: break-word;
            max-height: 30px;
            overflow-y: auto;
            scrollbar-width: none;
        }

        .card-text:hover {
            scrollbar-width: thin;
        }

        .card-grid {
            display: flex;
            flex-direction: column;
            grid-template-rows: 1fr 44px;
            grid-template-areas:
                "main"
                "footer";
        }

        .card-main {
            grid-area: main;
        }

        .card-footer {
            grid-area: footer;
            margin-top: auto;
            display: grid;
            grid-template-rows: auto auto;
            justify-content: flex-start;
            align-items: center;
            row-gap: 4px;
            padding: 0; 
            background-color: #ffffff;
            border-top: none
        }

        .card-footer .card-likes {
            grid-row: 1;
        }

        .card-footer .edit-button,
        .card-footer .delete-button,
        .card-footer .link-like {
            grid-row: 2;
            margin-right: 6px;
        }

        .card.editing {
            max-height: 180px;
        }

        .card.editing .card-main {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .new-text {
            max-height: 60px;
            margin-bottom: 12px;
            overflow-y: auto; 
            scrollbar-width: none;
        }

        .new-text:hover {
            scrollbar-width: thin; 
        }

        .link-like {
            cursor: pointer;
            color: #0d6efd;
        }

        .link-like:hover {
            text-decoration: underline !important;
        }

        .btn-edit {
            background-color: #17a2b8;
            color: white;
        }

        .btn-edit:hover {
            background-color: #138496;
            color: white
        }
    </style>
</head>

<body>
<div class="wrap">
    <!-- 메모 작성 영역 -->
    <div class="post-box">
        <h1 class="display-4">
            나홀로메모장
            <span class="badge bg-secondary">ver2.0</span>
        </h1>

        <form id="memo-form" class="mt-4">
            <div class="mb-3 col-md-8">
                <input
                    id="memo-title"
                    name="title"
                    type="text"
                    class="form-control"
                    maxlength="14"
                    placeholder="제목을 입력하세요"
                    required
                >
            </div>
            <div class="mb-3 col-md-8">
                <textarea
                    id="memo-content"
                    name="content"
                    class="form-control"
                    rows="3"
                    placeholder="내용을 입력하세요"
                    required
                ></textarea>
            </div>
            <button type="submit" class="btn btn-primary">
                저장하기
            </button>
        </form>
    </div>
    <!-- 카드 목록 -->
    <div id="card-list">
        {% for memo in memos %}
        <div class="card" data-id="{{ memo._id }}" data-liked-at="0">
            <div class="card-body card-grid">
                <div class="card-main">
                    <h5 class="card-title">{{ memo.title }}</h5>
                    <p class="card-text">{{ memo.content }}</p>
                </div>
                <div class="card-footer">
                    <span class="card-likes">{{ memo.likes }}</span>
                    <button
                        class="edit-button btn btn-edit"
                        onclick="enterEditMode(this)">
                        수정
                    </button>
                    <button
                        class="delete-button btn btn-danger"
                        onclick="deleteMemo('{{ memo._id }}', this)">
                        삭제
                    </button>
                    <span
                        class="link-like btn btn-link text-decoration-none"
                        onclick="likeMemo('{{ memo._id }}')">
                        좋아요! <i class="bi bi-hand-thumbs-up"></i>
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
/* 메모 저장 */
document.getElementById("memo-form").addEventListener("submit", e => {
    e.preventDefault();
    fetch("/memo", {
        method: "POST",
        body: new FormData(e.target)
    }).then(res => {
        if (!res.ok) throw new Error();
        alert("포스팅 완료!");
        location.reload();
    }).catch(() => alert("저장에 실패했습니다."));
});


/* 좋아요 낙관적 UI */
function likeMemo(id) {
    const card = document.querySelector(`.card[data-id="${id}"]`);
    const likesEl = card.querySelector(".card-likes");
    const prevLikes = likesEl.innerText;
    const prevLikedAt = card.dataset.likedAt;

    likesEl.innerText = Number(prevLikes) + 1;
    card.dataset.likedAt = Date.now();
    sortCards();

    fetch(`/like/${id}`, { method: "POST" })
        .then(res => {
            if (!res.ok) throw new Error();
        }).catch(() => {
            likesEl.innerText = prevLikes;
            card.dataset.likedAt = prevLikedAt;
            sortCards();
            alert("좋아요에 실패했습니다.");
        });
}


/* 좋아요 기준 내림차순 정렬 */
function sortCards() {
    const list = document.getElementById("card-list");
    const cards = Array.from(list.children);

    cards.sort((a, b) => {
        const likesA = Number(a.querySelector(".card-likes").innerText);
        const likesB = Number(b.querySelector(".card-likes").innerText);

        // 좋아요 수 우선
        if (likesA !== likesB) {
            return likesB - likesA;
        }

        // 좋아요 수가 같으면 최근에 누른 카드 우선
        return Number(b.dataset.likedAt) - Number(a.dataset.likedAt);
    });

    cards.forEach(card => list.appendChild(card));
}


/* 삭제*/
function deleteMemo(id, btn) {
    fetch(`/delete/${id}`, { method: "DELETE" })
        .then(res => {
            if (!res.ok) throw new Error();
            alert("삭제 완료!");
            location.reload();
        }).catch(() => alert("삭제에 실패했습니다."));
}


/* 수정 모드 */
function enterEditMode(btn) {
    const card = btn.closest(".card");
    card.classList.add("editing");

    const cardMain = card.querySelector(".card-main");
    const cardFooter = card.querySelector(".card-footer");

    const title = cardMain.querySelector(".card-title").innerText;
    const content = cardMain.querySelector(".card-text").innerText;

    cardMain.innerHTML = `
        <input
            class="new-title form-control"
            maxlength="14"
            value="${title}">
        <textarea
            class="new-text form-control"
            rows="2">${content}</textarea>
    `;

    cardFooter.innerHTML = `
        <button
            class="save-button btn btn-success"
            onclick="saveEdit('${card.dataset.id}', this)">
            저장
        </button>
    `;
}


/* 수정 저장*/
function saveEdit(id, btn) {
    const card = btn.closest(".card");
    const title = card.querySelector(".new-title").value;
    const content = card.querySelector(".new-text").value;

    fetch(`/update/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ title, content })
    }).then(res => {
        if (!res.ok) throw new Error();
        alert("수정 완료!");
        location.reload();
    }).catch(() => alert("수정에 실패했습니다."));
}
</script>
</body>
</html>
