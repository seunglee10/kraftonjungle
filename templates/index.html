<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>나홀로메모장 ver2.0</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <style>
        * {
            font-family: 'Stylish', sans-serif;
        }

        .wrap {
            width: 900px;
            margin: auto;
        }

        .post-box {
            background-color: #e9ecef;
            padding: 40px;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        #card-list {
            column-count: 3;
            column-gap: 1rem;
        }

        .card {
            break-inside: avoid;
            min-height: 200px;
            margin-bottom: 10px;
        }

        .card.editing {
            min-height: 200px;
        }
        
        .link-like {
            cursor: pointer;
            color: #0d6efd;
        }
        
        .btn-edit {
            background-color: #17a2b8;
            color: white;
        }
        .btn-edit:hover {
            background-color: #138496;
            color: white
        }
    </style>
</head>

<body>
<div class="wrap">

    <!-- 메모 작성 영역 (사진과 동일) -->
    <div class="post-box">
        <h1 class="display-4">
            나홀로메모장
            <span class="badge bg-secondary">ver2.0</span>
        </h1>

        <form id="memo-form" class="mt-4">
            <div class="mb-3 col-md-8">
                <input
                    id="memo-title"
                    name="title"
                    type="text"
                    class="form-control"
                    placeholder="제목을 입력하세요"
                    required
                >
            </div>

            <div class="mb-3 col-md-8">
                <textarea
                    id="memo-content"
                    name="content"
                    class="form-control"
                    rows="3"
                    placeholder="내용을 입력하세요"
                    required
                ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">
                저장하기
            </button>
        </form>
    </div>

    <!-- 카드 목록 -->
    <div id="card-list">
        {% for memo in memos %}
        <div class="card" data-id="{{ memo._id }}" data-liked-at="0">
            <div class="card-body">
                <h5 class="card-title">{{ memo.title }}</h5>
                <p class="card-text">{{ memo.content }}</p>
                <div class="mb-2">
                    <span class="card-likes">{{ memo.likes }}</span>
                </div>
                <button
                    class="edit-button btn btn-edit"
                    onclick="enterEditMode(this)">
                    수정
                </button>

                <button
                    class="delete-button btn btn-danger"
                    onclick="deleteMemo('{{ memo._id }}', this)">
                    삭제
                </button>

                <span
                    class="link-like btn btn-link text-decoration-none" 
                    onclick="likeMemo('{{ memo._id }}')">
                    좋아요! <i class="bi bi-hand-thumbs-up"></i>
                </span>

            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
/* 메모 저장 (reload) */
document.getElementById("memo-form").addEventListener("submit", e => {
    e.preventDefault();
    fetch("/memo", {
        method: "POST",
        body: new FormData(e.target)
    }).then(() => {
        alert("포스팅 완료!");
        location.reload();
    });
});


/* 좋아요: 낙관적 UI + 즉시 재정렬 */
function likeMemo(id) {
    const card = document.querySelector(`.card[data-id="${id}"]`);
    const likesEl = card.querySelector(".card-likes");

    likesEl.innerText = Number(likesEl.innerText) + 1;
    card.dataset.likedAt = Date.now();
    sortCards();

    fetch(`/like/${id}`, { method: "POST" })
        .catch(() => location.reload());
}


/* 좋아요 기준 내림차순 정렬 */
function sortCards() {
    const list = document.getElementById("card-list");
    const cards = Array.from(list.children);

    cards.sort((a, b) => {
        const likesA = Number(a.querySelector(".card-likes").innerText);
        const likesB = Number(b.querySelector(".card-likes").innerText);

        // 좋아요 수 우선
        if (likesA !== likesB) {
            return likesB - likesA;
        }

        // 좋아요 수가 같으면 최근에 누른 카드 우선
        return Number(b.dataset.likedAt) - Number(a.dataset.likedAt);
    });

    cards.forEach(card => list.appendChild(card));
}


/* 삭제 (reload) */
function deleteMemo(id, btn) {
    fetch(`/delete/${id}`, { method: "DELETE" })
        .then(() => {
            alert("삭제 완료!");
            location.reload();
        });
}


/* 수정 모드 */
function enterEditMode(btn) {
    const card = btn.closest(".card");
    card.classList.add("editing");

    const title = card.querySelector(".card-title").innerText;
    const content = card.querySelector(".card-text").innerText;

    card.querySelector(".card-body").innerHTML = `
        <input class="new-title form-control mb-2" value="${title}">
        <textarea class="new-text form-control mb-2" rows="2">${content}</textarea>
        <button class="btn btn-success"
                onclick="saveEdit('${card.dataset.id}', this)">
            저장
        </button>
    `;
}


/* 수정 저장 (reload) */
function saveEdit(id, btn) {
    const card = btn.closest(".card");
    const title = card.querySelector(".new-title").value;
    const content = card.querySelector(".new-text").value;

    fetch(`/update/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ title, content })
    }).then(() => {
        alert("수정 완료!");
        location.reload();
    });
}
</script>
</body>
</html>
