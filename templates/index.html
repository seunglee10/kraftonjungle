<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚˜í™€ë¡œë©”ëª¨ì¥ ver2.0</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Stylish&display=swap" rel="stylesheet">

    <style>
        * {
            font-family: 'Stylish', sans-serif;
        }

        .wrap {
            width: 900px;
            margin: auto;
        }

        .post-box {
            background-color: #e9ecef;
            padding: 40px;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        #card-list {
            column-count: 3;
            column-gap: 1rem;
        }

        .card {
            break-inside: avoid;
            min-height: 200px;
            margin-bottom: 10px;
        }

        .card.editing {
            min-height: 200px;
        }
        .link-like {
            cursor: pointer;
            color: #0d6efd;
        }
        
        .btn-edit {
            background-color: #17a2b8;
            color: white;
        }
        .btn-edit:hover {
            background-color: #138496;
        }
    </style>
</head>

<body>
<div class="wrap">

    <!-- ë©”ëª¨ ì‘ì„± ì˜ì—­ (ì‚¬ì§„ê³¼ ë™ì¼) -->
    <div class="post-box">
        <h1 class="display-4">
            ë‚˜í™€ë¡œë©”ëª¨ì¥
            <span class="badge bg-secondary">ver2.0</span>
        </h1>

        <form id="memo-form" class="mt-4">
            <div class="mb-3 col-md-8">
                <input
                    id="memo-title"
                    name="title"
                    type="text"
                    class="form-control"
                    placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    required
                >
            </div>

            <div class="mb-3 col-md-8">
                <textarea
                    id="memo-content"
                    name="content"
                    class="form-control"
                    rows="3"
                    placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    required
                ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">
                ì €ì¥í•˜ê¸°
            </button>
        </form>
    </div>

    <!-- ì¹´ë“œ ëª©ë¡ -->
    <div id="card-list">
        {% for memo in memos %}
        <div class="card" data-id="{{ memo._id }}">
            <div class="card-body">
                <h5 class="card-title">{{ memo.title }}</h5>
                <p class="card-text">{{ memo.content }}</p>
                <div class="mb-2">
                    <span class="card-likes">{{ memo.likes }}</span>
                </div>
                <button
                    class="edit-button btn btn-edit"
                    onclick="enterEditMode(this)">
                    ìˆ˜ì •
                </button>

                <button
                    class="delete-button btn btn-danger"
                    onclick="deleteMemo('{{ memo._id }}', this)">
                    ì‚­ì œ
                </button>

                <span
                    class="link-like btn btn-link text-decoration-none" 
                    onclick="likeMemo('{{ memo._id }}')">
                    ì¢‹ì•„ìš”ğŸ‘
                </span>

            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
/* ë©”ëª¨ ì €ì¥ (reload) */
document.getElementById("memo-form").addEventListener("submit", e => {
    e.preventDefault();
    fetch("/memo", {
        method: "POST",
        body: new FormData(e.target)
    }).then(() => {
        alert("í¬ìŠ¤íŒ… ì™„ë£Œ!");
        location.reload();
    });
});


/* ì¢‹ì•„ìš”: ë‚™ê´€ì  UI + ì¦‰ì‹œ ì¬ì •ë ¬ */
function likeMemo(id) {
    const card = document.querySelector(`.card[data-id="${id}"]`);
    const likesEl = card.querySelector(".card-likes");

    likesEl.innerText = Number(likesEl.innerText) + 1;
    sortCards();

    fetch(`/like/${id}`, { method: "POST" })
        .catch(() => location.reload());
}


/* ì¢‹ì•„ìš” ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ */
function sortCards() {
    const list = document.getElementById("card-list");
    const cards = Array.from(list.children);

    cards.sort((a, b) => {
        return Number(
            b.querySelector(".card-likes").innerText
        ) - Number(
            a.querySelector(".card-likes").innerText
        );
    });

    cards.forEach(card => list.appendChild(card));
}


/* ì‚­ì œ (reload) */
function deleteMemo(id, btn) {
    fetch(`/delete/${id}`, { method: "DELETE" })
        .then(() => {
            alert("ì‚­ì œ ì™„ë£Œ!");
            location.reload();
        });
}


/* ìˆ˜ì • ëª¨ë“œ */
function enterEditMode(btn) {
    const card = btn.closest(".card");
    card.classList.add("editing");

    const title = card.querySelector(".card-title").innerText;
    const content = card.querySelector(".card-text").innerText;

    card.querySelector(".card-body").innerHTML = `
        <input class="new-title form-control mb-2" value="${title}">
        <textarea class="new-text form-control mb-2" rows="2">${content}</textarea>
        <button class="btn btn-success"
                onclick="saveEdit('${card.dataset.id}', this)">
            ì €ì¥
        </button>
    `;
}


/* ìˆ˜ì • ì €ì¥ (reload) */
function saveEdit(id, btn) {
    const card = btn.closest(".card");
    const title = card.querySelector(".new-title").value;
    const content = card.querySelector(".new-text").value;

    fetch(`/update/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ title, content })
    }).then(() => {
        alert("ìˆ˜ì • ì™„ë£Œ!");
        location.reload();
    });
}
</script>
</body>
</html>
